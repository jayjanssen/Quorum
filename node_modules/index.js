// Copyright (c) 2011 Yahoo! Inc. All rights reserved. Licensed under the BSD
// License. See accompanying LICENSE file or
// http://www.opensource.org/licenses/BSD-3-Clause for the specific language
// governing permissions and limitations under the
// License.

var log = require( 'logger' )( 'Index', 'DEBUG');
var connect = require('connect');
var url = require('url');

var QuorumRequest = require("./request");
var RestV1 = require("./rest_v1" );
  
module.exports = connect.createServer(function (req, resp) {  
  // Creating the QuorumRequest will generate an exception on bad input
  try {    
    RestV1.handle( QuorumRequest( req ), function( code, headers, content ) {
      resp.writeHead( code, headers );
      resp.end( content );
    });
  } catch( e ) {
    if( e.code !== undefined ) {
      resp.statusCode = e.code;
      resp.end( e.message + '\n' );
    } else {
      resp.statusCode = 500;
      resp.end( "Unknown error: " + e.toString() );
      log.warn( 'Unhandled exception: ' + e.toString() );
    }
  }
});

log.info( "Started Quorum V1 server" );